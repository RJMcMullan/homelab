
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../cloudflared-traefik/">
      
      
        <link rel="next" href="../../../docker/dev_container/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>Traefik-HAProxy - My homelab</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#haproxy-traefik-lets-encrypt-wildcard-certificates-100-a-ssl-rating" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="My homelab" class="md-header__button md-logo" aria-label="My homelab" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My homelab
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Traefik-HAProxy
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../kubernetes/kubespray/upgrade-process/" class="md-tabs__link">
          
  
  Kubernetes

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../cloudflared-traefik/" class="md-tabs__link">
          
  
  External Access

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../docker/dev_container/" class="md-tabs__link">
          
  
  Docker

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../dd" class="md-tabs__link">
          
  
  Linux Admin

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="My homelab" class="md-nav__button md-logo" aria-label="My homelab" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My homelab
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/kubespray/upgrade-process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubespray
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    External Access
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            External Access
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cloudflared-traefik/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Traefik
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Traefik-HAProxy
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Traefik-HAProxy
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-plugin-installation" class="md-nav__link">
    <span class="md-ellipsis">
      Part 1 - Plugin Installation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-dynamic-dns-configuration-using-cloudflare" class="md-nav__link">
    <span class="md-ellipsis">
      Part 2 - Dynamic DNS Configuration using cloudflare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-3-lets-encrypt-acme-client" class="md-nav__link">
    <span class="md-ellipsis">
      Part 3 - Let's Encrypt (ACME Client)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-5-haproxy-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Part 5 - HAProxy Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-6-internal-network-access" class="md-nav__link">
    <span class="md-ellipsis">
      Part 6 - Internal Network Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-7-local-access-only-subdomains" class="md-nav__link">
    <span class="md-ellipsis">
      Part 7 - Local-Access-Only Subdomains
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-8-hide-certificate-on-ip-access" class="md-nav__link">
    <span class="md-ellipsis">
      Part 8 - Hide Certificate on IP Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-9-ssllabs-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Part 9 - ssllabS testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-10-traefik-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Part 10 - Traefik setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 10 - Traefik setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-by-step-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Docker
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Docker
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/dev_container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Container
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux Admin
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Linux Admin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../dd" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    None
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-plugin-installation" class="md-nav__link">
    <span class="md-ellipsis">
      Part 1 - Plugin Installation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-dynamic-dns-configuration-using-cloudflare" class="md-nav__link">
    <span class="md-ellipsis">
      Part 2 - Dynamic DNS Configuration using cloudflare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-3-lets-encrypt-acme-client" class="md-nav__link">
    <span class="md-ellipsis">
      Part 3 - Let's Encrypt (ACME Client)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-5-haproxy-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Part 5 - HAProxy Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-6-internal-network-access" class="md-nav__link">
    <span class="md-ellipsis">
      Part 6 - Internal Network Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-7-local-access-only-subdomains" class="md-nav__link">
    <span class="md-ellipsis">
      Part 7 - Local-Access-Only Subdomains
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-8-hide-certificate-on-ip-access" class="md-nav__link">
    <span class="md-ellipsis">
      Part 8 - Hide Certificate on IP Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-9-ssllabs-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Part 9 - ssllabS testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-10-traefik-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Part 10 - Traefik setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 10 - Traefik setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-by-step-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="haproxy-traefik-lets-encrypt-wildcard-certificates-100-a-ssl-rating">HAProxy + Traefik + Let's Encrypt Wildcard Certificates + 100% A+ ssl Rating</h1>
<h2 id="configuration-guide">Configuration Guide</h2>
<p>This is the help anyone wanting to implement a reverse proxy into their homelab environment, for hosting personal websites and projects to the public.</p>
<h3 id="part-1-plugin-installation">Part 1 - Plugin Installation</h3>
<p>1. <strong>Update your OPNsense to the latest version and ensure you're using the OpenSSL firmware flavor, as LibreSSL doesn't support TLS 1.3.</strong>
- Navigate to "System --&gt; Firmware --&gt; Updates" and install all updates.</p>
<p>2. <strong>Install necessary plugins:</strong>
- Go to "System --&gt; Firmware --&gt; Plugins" and install the following: <code>os-acme-client</code>, <code>os-ddclient</code>, <code>os-haproxy</code>.</p>
<h3 id="part-2-dynamic-dns-configuration-using-cloudflare">Part 2 - Dynamic DNS Configuration using cloudflare</h3>
<p>1. <strong>Create and verify an account on <a href="https://dash.cloudflare.com/sign-up">cloudflare</a>.</strong></p>
<p>2. <strong>Create your subdomain:</strong>
- Go to <a href="https://dash.cloudflare.com/">cloudflare &gt; websites &gt; domain name &gt; DNS &gt; records</a> and create your domain (e.g. <code>homelab.devopsjourneys.wiki</code>).</p>
<p><img alt="1" src="../../../images/cloudflared_docker/subdomain_dns.png" /></p>
<p>3. <strong>Generate and save a token:</strong>
   - Log in to your Cloudflare account and navigate to the dashboard.
   - Click on the profile icon in the top right corner and select "My Profile."
   - In the left-hand menu, click on "API Tokens," then select "Create Token."
   - Choose the "Edit zone DNS" template from the list of API token templates.
   - In the "Zone Resources" section, select the desired domain from the right-most dropdown menu, then click "Continue to summary."
   - Verify that the API token has DNS
   - permission for the selected domain and click "Create Token."</p>
<p>4. Setup the Dynamic DNS plugin in OPNSENSE and enter the following information:</p>
<ul>
<li>Enabled: true</li>
<li>Description: Cloudflare (Or whatever you want)</li>
<li>Service: Cloudflare</li>
<li>Username: token (the word, not your API token)</li>
<li>Password: <The cloudflare API key you generated earlier></li>
<li>Zone: your.domain (e.g. devopsjourneys.wiki)</li>
<li>Hostname: full domain name (e.g. homelab.devopsjourneys.wiki)</li>
<li>Check ip method: Interface</li>
<li>Interface to monitor: WAN</li>
<li>Force SSL: true
  <img alt="2" src="../../../images/cloudflared_docker/ACME.png" />
  <img alt="3" src="../../../images/cloudflared_docker/cloudflare_account.png" /></li>
</ul>
<h3 id="part-3-lets-encrypt-acme-client">Part 3 - Let's Encrypt (ACME Client)</h3>
<p>1. <strong>Configure ACME Client settings in OPNsense:</strong></p>
<p>- Navigate to "Services --&gt; ACME Client --&gt; Settings" and adjust settings as this image<img alt="4" src="../../../images/cloudflared_docker/Configure_ACME_Client_settings_in_OPNsense.png" />.</p>
<p>2. <strong>Set update schedule for certificate renewal:</strong></p>
<p>In this section, we will set the time of day for certificate renewals. Certificates won't be renewed daily; the ACME client first checks if they are nearing expiration and only renews them if necessary. Schedule the renewal for a time when your services experience low traffic, as the ACME plugin will restart HAProxy to apply the new certificates, causing a brief downtime. Avoid scheduling renewals at exact hours (e.g., 3:00 AM) since Let's Encrypt servers might be overloaded, potentially causing the renewal process to fail
  - Go to "Services --&gt; ACME Client --&gt; Settings --&gt; Update Schedule" and configure a time with low service load.
3. <strong>Create an ACME account:</strong>
  - Go to "Services --&gt; ACME Client --&gt; Accounts" and create an account using the staging environment first.
<img alt="5" src="../../../images/cloudflared_docker/Create_an_ACME_account.png" /></p>
<p>4. <strong>Set up automation:</strong>
  - Create an automation to restart HAProxy after certificate renewal.
<img alt="6" src="../../../images/cloudflared_docker/Set_up_automation.png" />
5. <strong>Add DNS challenge:</strong>
  - Go to "Services --&gt; ACME Client --&gt; Challenge Types" and add the DNS challenge for deSEC.
<img alt="7" src="../../../images/cloudflared_docker/DNS_challenge.png" />
6. <strong>Add your certificate:</strong>
  - Configure the certificate in "Services --&gt; ACME Client --&gt; Certificates".
 <img alt="8" src="../../../images/cloudflared_docker/Add_your_certificate.png" />
I prefer using Elliptic Curve Cryptography (ECC) (https://en.wikipedia.org/wiki/Elliptic-curve_cryptography). However, you can also use RSA keys. If you choose RSA, ensure the key length is as long as possible to achieve an A+ rating from SSLLabs.
  - Forcefully issue a staging certificate for testing, then switch to the production environment and issue the certificate by selecting the highlighted part here:
<img alt="9" src="../../../images/cloudflared_docker/Forcefully_issue_a_staging_certificate_for_testing.png" /></p>
<p>### Part 4 - System Preparation</p>
<p>1. <strong>Adjust system settings:</strong>
  - Go to "System --&gt; Settings --&gt; Administration" and change the Web GUI TCP port (anything other than 443), and disable the web GUI redirect rule.</p>
<p>2. <strong>Optional: Configure Virtual IPs:</strong>
Create a virtual IP in a subnet different from any of your other networks. Ideally, select an IP from the localhost subnet to avoid conflicts in your local network (https://en.wikipedia.org/wiki/Localhost). In this tutorial, we will use "127.4.4.3/32" as the IP address for both the "HTTP_frontend" and "HTTPS_frontend".
  - Create a virtual IP in "Interfaces --&gt; Virtual IPs --&gt; Settings" if not using localhost.
<img alt="10" src="../../../images/cloudflared_docker/Configure_Virtual_IPs.png" />
3. <strong>Create a firewall alias:</strong>
  - Go to "Firewall --&gt; Aliases" and create an alias for HAProxy ports (port 80 and 443).
<img alt="11" src="../../../images/cloudflared_docker/Create_a_firewall_alias.png" />
4. <strong>Set up firewall rules:</strong>
  - Allow inbound traffic on HAProxy ports via "Firewall --&gt; Rules --&gt; WAN".
<img alt="12" src="../../../images/cloudflared_docker/Set_up_firewall_rules.png" /></p>
<h3 id="part-5-haproxy-configuration">Part 5 - HAProxy Configuration</h3>
<p>1. <strong>Configure HAProxy settings:</strong>
  - Go to "Services --&gt; HAProxy --&gt; Settings --&gt; Service" and adjust as needed.
<img alt="13" src="../../../images/cloudflared_docker/Configure_HAProxy_settings.png" />
   - Update "Global Parameters" and "Default Parameters" in HAProxy settings.
<img alt="14" src="../../../images/cloudflared_docker/Configure_HAProxy_settings_global.png" />
<img alt="15" src="../../../images/cloudflared_docker/Configure_HAProxy_settings_global2.png" /></p>
<p>2. <strong>Add real servers and backend pools:</strong>
  - Here we add the "Real Servers" the internal IP in my case of my traefik instance running on docker, the description and port
  - The wildcard certificate we created above is also added here *.devopsjourney.wiki
  <img alt="16" src="../../../images/cloudflared_docker/Add_real_servers_and_backend_pools.png" />
  <img alt="17" src="../../../images/cloudflared_docker/Add_real_servers_and_backend_pools2.png" /></p>
<ul>
<li>Set up backend pools for services in "Virtual Services --&gt; Backend Pools".</li>
</ul>
<p><img alt="18" src="../../../images/cloudflared_docker/Add_real_servers_and_backend_pools3.png" />
<img alt="19" src="../../cloudflared/images/cloudflared_docker/Edit _Backend_Pool2.png" />
<img alt="20" src="../../../images/cloudflared_docker/Add_real_servers_and_backend_pools4.png" />
3. <strong>Create rules and conditions:</strong>
  - Add a NoSSL_condition", which is necessary in order to identify non-HTTPS traffic
  <img alt="21" src="../../../images/cloudflared_docker/Create_rules_and_conditions.png" />
  - Create a HTTPtoHTTPS rule. This is so the client connection gets upgraded from HTTP to HTTPS and connects to the HTTPS_frontend<img alt="22" src="../../../images/cloudflared_docker/Create_HTTPtoHTTPS_rule.png" />
  - Create map files for public subdomains.
 Here, we will generate a new map file named "PUBLIC_SUBDOMAINS_mapfile" for the public subdomains we want to access externally from our network. HAProxy map files are used to store key-value pairs that can be referenced by HAProxy during its operation. These map files allow for efficient lookups and are typically used for tasks such as URL rewriting, header modification, or directing traffic based on specific criteria.
Key features of HAProxy map files include:
- Format: Each line in a map file represents a key-value pair, separated by spaces or tabs. The key is usually some form of input (like a URL or host) and the value is the corresponding output (like a backend server or a rewritten URL).</p>
<p>Example:
  subdomain1.example.com backend1
  subdomain2.example.com backend2</p>
<ul>
<li>Usage: Map files are referenced in HAProxy configuration using directives such as use-server, acl, or http-request. This enables dynamic behavior based on the contents of the map file.</li>
<li>Efficiency: Map files allow HAProxy to handle complex routing and transformation rules efficiently without hardcoding them into the configuration, enabling easier updates and maintenance.</li>
<li>
<p>Reloading: HAProxy can reload map files on the fly without requiring a full restart, which minimizes downtime and allows for dynamic updates to routing logic.</p>
</li>
<li>
<p>Now create the Map file and PUBLIC_SUBDOMAINS_map-rule as follows
  <img alt="23" src="../../../images/cloudflared_docker/PUBLIC_SUBDOMAINS_map-rule.png" />
  <img alt="24" src="../../../images/cloudflared_docker/PUBLIC_SUBDOMAINS_map-rule2.png" /></p>
</li>
</ul>
<p>4. <strong>Configure Public Services (frontends):</strong>
  - Set up SNI, HTTP, and HTTPS frontends in "Virtual Services --&gt; Public Services".
  Here, we will set up the frontends to listen on our interface IPs and the virtual IP we created earlier. First, we will create the "SNI_frontend," which will determine whether the traffic should be SSL offloaded. You will need to place the rules for all services that you don't want to be SSL offloaded here. The default backend for this frontend will be the "SSL_backend," which redirects all traffic to our virtual "SSL_server," corresponding to our "HTTPS_frontend."
  <img alt="25" src="../../../images/cloudflared_docker/public_service_frontend.png" />
  - Now we will set up our "HTTP_frontend." Ensure that the "HTTPtoHTTPS_rule" is included in this frontend! This frontend is essential for redirecting HTTP traffic to HTTPS, but it can also be used to serve non-SSL encrypted services on port 80.
  <img alt="26" src="../../../images/cloudflared_docker/public_service_frontend2.png" />
  <img alt="27" src="../../../images/cloudflared_docker/public_service_frontend3.png" />
  <img alt="28" src="../../../images/cloudflared_docker/public_service_frontend4.png" />
  - Now we will set up our "HTTPS_frontend." This will be our primary frontend, performing SSL offloading using the Let's Encrypt certificate we created earlier. You should include the "PUBLIC_SUBDOMAINS_rule" and all other rules for services that need SSL offloading here. The "Cipher List" and "Cipher Suites" will ensure we achieve a 100% A+ rating at SSLLabs.</p>
<h3 id="part-6-internal-network-access">Part 6 - Internal Network Access</h3>
<p>1. <strong>Option A: Split DNS:</strong>
   If you attempt to access your URL "your_service.your_subdomain.dedyn.io" from a device within your internal network, it should fail There are two ways to resolve this issue. I will cover both options, but note that Split DNS (Option A) is the recommended approach. NAT Reflection (Option B) is a less favorable solution because it causes you to lose the ability to track the originating source IP in HAProxy when using NAT.</p>
<p>Option A - Split DNS (https://docs.opnsense.org/manual/unbound.html#overrides)
Option B - NAT Reflection (https://docs.opnsense.org/manual/nat.html)
  - Use Unbound DNS plugin for DNS overrides.
  - Go to "Services --&gt; Unbound DNS --&gt; Overrides" and create host overrides for each of your services. This applies if you are using second-level subdomains like "your_service.your_subdomain.dedyn.io" for your services. If all your services run on your first-level subdomain "your_subdomain.dedyn.io," you only need to override this one. The IP address can be any LAN (or VLAN) interface IP of your OPNsense. I am using the LAN IP that the "SNI_frontend" is also listening on, since we set it to "0.0.0.0".</p>
<p>2. <strong>Option B: NAT Reflection:</strong></p>
<ul>
<li>Edit port forwarding rules in "Firewall --&gt; NAT --&gt; Port Forward" to enable NAT reflection.</li>
</ul>
<h3 id="part-7-local-access-only-subdomains">Part 7 - Local-Access-Only Subdomains</h3>
<p>1. <strong>Create a local map file:</strong>
 - In OPNsense, navigate to: Services --&gt; HAProxy --&gt; Settings --&gt; Advanced --&gt; Map Files. Here, clone the "PUBLIC_SUBDOMAINS_mapfile," rename it to something like "LOCAL_SUBDOMAINS_mapfile," and add all your local-access-only subdomains along with their corresponding backends. Remember that the contents of your "PUBLIC_SUBDOMAINS_mapfile" must also be included in the "LOCAL_SUBDOMAINS_mapfile." I will explain the reason for this later.</p>
<p>2. <strong>Add local conditions and rules:</strong>
 - Next, go to: Services --&gt; HAProxy --&gt; Settings --&gt; Rules &amp; Checks --&gt; Conditions. Create a condition to detect if the source of the request is a local IP or a FQDN. You can use the predefined "Source IP is local" condition, but I prefer to use specific subnets since the predefined condition covers the entire RFC1918 IP range, which is more than I need. As mentioned, you can also check for a FQDN. However, keep in mind that HAProxy resolves these hostnames to their IPs at startup or restart. If the IP of your FQDN changes frequently, this won't work well unless you restart HAProxy regularly, such as every 24 hours using a cron job.
<img alt="29" src="../../../images/cloudflared_docker/Local-Access-Only_Subdomains.png" />
- Next, go to: Services --&gt; HAProxy --&gt; Settings --&gt; Rules &amp; Checks --&gt; Rules. Clone the "PUBLIC_SUBDOMAINS_rule," rename it to something like "LOCAL_SUBDOMAINS_rule," select your "LOCAL_SUBDOMAINS_SUBNETS_condition," and choose your "LOCAL_SUBDOMAINS_mapfile." If you are also using a FQDN condition, like I am, you need to select both your FQDN and subnet conditions with the logical "or" operator.
 <img alt="30" src="../../../images/cloudflared_docker/LOCAL_SUBDOMAINS_mapfile.png" />
 - Finally, go to: Services --&gt; HAProxy --&gt; Settings --&gt; Virtual Services --&gt; Public Services. Place the "LOCAL_SUBDOMAINS_rule" before your "PUBLIC_SUBDOMAINS_rule" in your "HTTPS_frontend."
<img alt="31" src="../../../images/cloudflared_docker/Place_the_LOCAL_SUBDOMAINS_rule_before%20your_PUBLIC_SUBDOMAINS_rule.png" /></p>
<h3 id="part-8-hide-certificate-on-ip-access">Part 8 - Hide Certificate on IP Access</h3>
<p>1. <strong>Enable strict SNI:</strong>
  - Edit "HTTPS_frontend" in "Virtual Services --&gt; Public Services".
  - Change "curves secp384r1" to "curves secp384r1 strict-sni" in the SSL options.</p>
<h3 id="part-9-ssllabs-testing">Part 9 - ssllabS testing</h3>
<p>We are now going to test our configuration for secureness.
1. Go to https://www.ssllabs.com/ssltest/
2. Enter your domain to test
3. This will perform deep ssl testing on your domain
4. Wait for the results. You should now have an A+ rating
<img alt="32" src="../../../images/cloudflared_docker/ssllabS_testing.png" /></p>
<h3 id="part-10-traefik-setup">Part 10 - Traefik setup</h3>
<p>Here we are going to use our HAProxy as a reverse proxy in front of Traefik, which then proxies requests to this blog, you'll need to carefully configure each component to work together</p>
<h4 id="prerequisites">Prerequisites</h4>
<p>1. Docker: Ensure Docker is installed and running on your server.
2. Docker Compose: Ensure Docker Compose is installed.
3. HAProxy: Familiarity with HAProxy configuration.</p>
<h4 id="step-by-step-guide">Step-by-Step Guide</h4>
<p>1. Create a Docker Network for traefik and database network to be used by the blog
Create a Docker network that all services will use to communicate.</p>
<pre><code class="language-bash">  docker network create traefik
  docker network create db
</code></pre>
<p>2. Deploy traefik using docker compose</p>
<pre><code class="language-docker">networks:
  traefik:
    external: true
volumes:
  traefik_config:
    external: true
  lets_encrypt:
  traefik_dynamic_config:
    external: true
services:
  reverse-proxy:
    # The official v2 Traefik docker image
    image: traefik:v2.11.2
    # Enables the web UI and tells Traefik to listen to docker
    command: --api.insecure=true --metrics.prometheus=true --metrics.prometheus.manualrouting=true
      - &quot;--entrypoints.websecure.address=:443&quot;
      - &quot;--entrypoints.web.address=:80&quot;
      - &quot;--log.level=DEBUG&quot;
      - &quot;--configFile=/etc/traefik/traefik.yml&quot;
    ports:
      # The HTTP port
      - &quot;80:80&quot;
      - &quot;443:443&quot;
      # The Web UI (enabled by --api.insecure=true)
      - &quot;8080:8080&quot;
      - &quot;8082:8082&quot;
    expose:
      - 8082
    restart: unless-stopped
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock
      - &quot;traefik_config:/etc/traefik/&quot;
      # Mount the dynamic configuration
      # Mount the cert directory
      - &quot;./certs/:/etc/certs/&quot;
    networks:
      - traefik
    logging:
      driver: fluentd
      options:
        fluentd-address: 127.0.0.1:24224
        fluentd-async: 'true'
        tag: docker.traefik

    labels:
      # Dynamic configuration with Docker Labels
      # Ref: https://docs.traefik.io/reference/dynamic-configuration/docker/
      # Explicitly tell Traefik to expose this container
      - traefik.enable=true
      # Allow request only from the predefined entry point named &quot;web&quot;
      - traefik.http.routers.traefik-ui.entrypoints=web
      # The port the dashboard responds on
      - traefik.http.services.traefik-ui.loadbalancer.server.port=8080
      # The URL for the traefik ui
      - traefik.http.routers.traefik-ui.rule=Host(`traefik-docker01.internal`)
</code></pre>
<p>3. Deploy wiki.js</p>
<pre><code class="language-docker"> services:

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: wiki
      POSTGRES_PASSWORD: wikijsrocks
      POSTGRES_USER: wikijs
    networks:
      - db
    logging:
      driver: &quot;fluentd&quot;
      options:
        fluentd-address: 127.0.0.1:24224
        fluentd-async: 'true'
        tag: docker.postgres_wiki
    labels:
      - &quot;com.centurylinklabs.watchtower.enable=false&quot;
    restart: unless-stopped
    volumes:
      - db-data:/var/lib/postgresql/data

  wiki:
    image: ghcr.io/requarks/wiki:2
    depends_on:
      - db
    networks:
      - traefik
      - db
    ports:
      - &quot;8084:3000&quot;
    environment:
      ADMIN_EMAIL:
      ADMIN_PASS: wikiadmin
      DB_TYPE: postgres
      DB_PORT: 5432
      DB_HOST: db
      DB_USER: wikijs
      DB_PASS: wikijsrocks
      DB_NAME: wiki
    restart: unless-stopped
    logging:
      driver: &quot;fluentd&quot;
      options:
        fluentd-address: 127.0.0.1:24224
        fluentd-async: 'true'
        tag: docker.wiki

    labels:
      # Dynamic configuration with Docker Labels
      # Ref: https://docs.traefik.io/reference/dynamic-configuration/docker/
      # Explicitly tell Traefik to expose this container
      - traefik.enable=true
      # The domain the service will respond to
      #- traefik.http.routers.wiki-web.rule=Host(`wiki-docker01.internal`)
      - traefik.http.routers.wiki-web.rule=Host(`homelab.devopsjourney.wiki`)
      # Allow request only from the predefined entry point named &quot;web&quot;
      - traefik.http.routers.wiki-web.entrypoints=web
      # if you have multiple ports exposed on the service, specify port in the web-secure service
      - traefik.http.services.wiki-web.loadbalancer.server.port=3000
      - &quot;com.centurylinklabs.watchtower.enable=false&quot;


volumes:
  db-data:
networks:
  traefik:
    external: true
  db:
    external: true
</code></pre>
<p>Things to note:
  - Make sure you set the <strong><em>traefik.http.routers.wiki-web.rule=Host</em></strong> to match your public DNS record in cloudflare</p>
<p>4. Go through steps 5 - 9 above to add the service to HAProxy in OPNsense
 <img alt="33" src="../../../images/cloudflared_docker/diagram_end.png" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.top", "navigation.sections"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>